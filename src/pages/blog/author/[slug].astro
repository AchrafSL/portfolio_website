---
import { getCollection } from "astro:content";
import BaseHead from "../../../components/BaseHead.astro";
import Header from "../../../components/sections/Header.astro";
import Footer from "../../../components/sections/Footer.astro";
import PostCard from "../../../components/ui/card/PostCard.astro";
import { author } from "../../../data/author";
import { slugifyTag as slugify } from "../../../lib/slug";

export const prerender = true;

export async function getStaticPaths() {
    try {
        const posts = await getCollection("blog");
        const authors = new Set();

        // Always include the default author to ensure at least one route exists
        authors.add(slugify(author.name));

        // Include authors from posts if they exist
        posts.forEach((p) => {
            if (p.data.author) {
                authors.add(slugify(String(p.data.author)));
            }
        });

        return Array.from(authors).map((authorSlug) => ({
            params: { slug: authorSlug },
        }));
    } catch (e) {
        console.error("Error in getStaticPaths for author:", e);
        // Fallback to the main author to prevent build failure on Cloudflare
        return [{ params: { slug: slugify(author.name) } }];
    }
}

const { slug } = Astro.params;
const posts = (await getCollection("blog")).filter(
    (p) => slugify(p.data.author || author.name) === slug,
);
const authorName = posts[0]?.data.author || author.name;
---

<html lang="en" data-theme="dark" class="dark">
    <head>
        <BaseHead
            title={`Articles by ${authorName}`}
            description={`Posts written by ${authorName}`}
        />
    </head>
    <body>
        <Header />
        <main class="mx-auto max-w-6xl px-4 py-10 space-y-6">
            <h1 class="text-3xl font-bold">Articles by {authorName}</h1>
            <div class="blog-grid">
                {posts.map((p) => <PostCard post={p} />)}
            </div>
        </main>
        <Footer />
    </body>
</html>
